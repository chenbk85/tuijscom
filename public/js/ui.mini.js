(function(a){a.cookie=function(){var e={path:false,domain:false,duration:false,secure:false,document:document};var c=function(g){g=g||{};for(var h in e){if(!g[h]){g[h]=e[h]}}return g};var d=function(i,j,h){h=c(h);if(h.domain){j+="; domain="+h.domain}if(h.path){j+="; path="+h.path}if(h.duration){var g=new Date();g.setTime(g.getTime()+h.duration*24*60*60*1000);j+="; expires="+g.toGMTString()}if(h.secure){j+="; secure"}h.document.cookie=i+"="+j};var f=function(h){var g=c();var i=g.document.cookie.match("(?:^|;)\\s*"+h.replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1")+"=([^;]*)");return(i)?decodeURIComponent(i[1]):null};var b=function(h,g){var g=c(g);g.duration=-1;d(h,"",g)};return{"write":d,"read":f,"clear":b}}()})(jQuery);var $Util={getUrlArgs:function(a,c){var b=c||window.location.href;if(new RegExp(".*\\b"+a+"\\b(\\s*=([^&]+)).*","gi").test(b)){return RegExp.$2}else{return""}},Ajax:function(b,a,d,e,c){$.ajax({type:b,url:a,dataType:"json",data:d,success:function(f){if(f.result==0){if(e){e(f)}else{$UI.showNoteMsg(f.msg,"success");window.location.reload()}}else{if(c){c(f)}else{$UI.showNoteMsg(f.msg,"warn")}}},error:function(f){$UI.showNoteMsg("系统繁忙，请刷新后重试！","warn")},complete:function(){if($("a[name=msg]").size()>0){location.hash="#msg"}if($(".btn_loading").size()>0){$(".btn_loading").hide()}}})},GET:function(a,c,d,b){this.Ajax("GET",a,c,d,b)},POST:function(a,c,d,b){this.Ajax("POST",a,c,d,b)},getToken:function(){if(!$.cookie.read("tkey")){return 0}var c=5381,d=$.cookie.read("tkey").substring(0,10);for(var b=0,a=d.length;b<a;++b){c+=(c<<5)+d.charCodeAt(b)}return c&2147483647},extend:function(b,d){if(b&&d&&typeof d=="object"){for(var a in d){b[a]=d[a]}}return b}};var $UI=(function(){var g={"warn":"nWarning","success":"nSuccess","fail":"nFailure","info":"nInformation"};function a(){var i=$(document).height();if($("#nav").size()>0){$("#nav").height(i)}}function d(i,j){var k=$(i);f(i);k.after('<span class="error"><b></b>'+j+"</span>")}function f(i){var j=$(i);if(j.next("span").size()>0){j.next("span").remove()}}function h(k,j){var i=j?g[j]:g["info"];if($("#noteMsg").size()>0){$("#noteMsg").attr("class","nNote "+i);$("#noteMsg").find("p").html(k);$("#noteMsg").show()}}function e(j){var i=$("#totop");i.removeClass("off on");if(j=="on"){i.addClass("on")}else{i.addClass("off")}}function c(){window.setInterval(function(){var i=$(document).scrollTop();var k=$(document).height();if(i>0){var j=i+k/2}else{var j=1}if(j<1000){e("off")}else{e("on")}},300);$("#totop").click(function(i){i.preventDefault();$("body,html").animate({scrollTop:0},{duration:500})})}function b(){$Util.GET("/base_info",{},function(l){var o=[];for(var k=0;k<l.toplist.length;k++){var p=l.toplist[k].libname?l.toplist[k].title+"："+l.toplist[k].libname:l.toplist[k].title;o.push('<li> › <a href="/lib/'+l.toplist[k]._id+'">'+p+"</a></li>")}$("#top_view").html(o.join(""));var m=[];for(var k=0;k<l.uselist.length;k++){var p=l.uselist[k].libname?l.uselist[k].title+"："+l.uselist[k].libname:l.uselist[k].title;m.push('<li> › <a href="/lib/'+l.uselist[k]._id+'">'+p+"</a></li>")}$("#top_use").html(m.join(""));var j=[];for(var k=0;k<l.taglist.length;k++){j.push('<a href="/tag/'+encodeURIComponent(l.taglist[k].name)+'">'+l.taglist[k].name+"</a>")}$("#top_tag").html(j.join(""));var n=l.count.toString();while(n.length<4){n="0"+n}$(".libnum-num").html(n)},function(i){})}return{initToTop:c,initPage:a,formError:d,showNoteMsg:h,hideFormError:f,initRight:b}})();var $Column=(function(){function b(){$("#column-form button").bind("click",function(){a()});$("#column_list .btn-inverse").bind("click",function(){var c=$(this).attr("data-id");if(c){$Util.GET("/del_column",{id:c})}});$("#column_list .btn-danger").bind("click",function(){var c=$(this).attr("data-id");if(c){$Util.GET("/hide_column",{id:c})}});$("#column_list .btn-success").bind("click",function(){var c=$(this).attr("data-id");if(c){$Util.GET("/restore_column",{id:c})}});$("#column_list .btn-primary").bind("click",function(){var d=$(this).attr("data-id");if(d){var c=$(this).parent().parent();$("#column-form input[name=id]").val(d);$("#column-form input[name=name_cn]").val(c.find("td").eq(0).html());$("#column-form input[name=name_en]").val(c.find("td").eq(1).html());$("#column-form select[name=type]").val(c.find("td").eq(2).attr("data-type"))}})}function a(){$Util.POST("/column",{id:$("#column-form input[name=id]").val(),type:$("#column-form select[name=type]").val(),name_cn:$("#column-form input[name=name_cn]").val(),name_en:$("#column-form input[name=name_en]").val()})}return{init:b}})();var $UserAdmin=(function(){function a(){$("#admin_user_list .btn-danger").bind("click",function(){var b=$(this).attr("data-id");if(b){$Util.GET("/lock_user",{id:b})}});$("#admin_user_list .btn-success").bind("click",function(){var b=$(this).attr("data-id");if(b){$Util.GET("/unlock_user",{id:b})}});$("#admin_user_list .btn-info").bind("click",function(){var b=$(this).attr("data-id");if(b){$Util.GET("/view_user",{id:b},function(c){for(name in c){if($("#user_info #user_"+name).size()>0){$("#user_info #user_"+name).html(c[name])}}$("#user_info header").html(c.username+"的用户信息");$("#user_info").show()})}})}return{init:a}})();var $UserLogin=(function(){var b={reg_success:"恭喜您注册成功，请登录！（已发送激活邮件至您的邮箱，请从邮箱激活！）",login_required:"登录后才能进行以下操作！",admin_required:"管理员才能进行以下操作！",token_error:"token错误，请确认后再试！"};var e=[1,1];function c(){$("#user-login-form input[name=loginname]").bind("blur",function(){var g=sanitize($(this).val()).trim();g=g.toLowerCase();e[0]=0;$UI.hideFormError(this);try{check(g,"用户名或邮箱错误！").len(5,20)}catch(f){e[0]=1;$UI.formError(this,f.message);return}});$("#user-login-form input[name=password]").bind("blur",function(){var f=sanitize($(this).val()).trim();e[1]=0;$UI.hideFormError(this);try{check(f,"密码长度必须在8~16之间！").len(8,16)}catch(g){e[1]=1;$UI.formError(this,g.message);return}});$("#user-login-form button").bind("click",function(){$("#user-login-form input[name=loginname]").blur();$("#user-login-form input[name=password]").blur();if(e.join("")!="00"){$UI.showNoteMsg("您输入的信息还有错误，请检查后重试！","warn");return}else{a()}})}function a(){var f=sanitize($("#user-login-form input[name=password]").val()).trim();f=md5(f);$Util.POST("/login",{loginname:$("#user-login-form input[name=loginname]").val(),password:f},function(g){$UI.showNoteMsg(g.msg,"success");window.location.href=g.url})}function d(){var g=$Util.getUrlArgs("msg");if(g&&b[g]){window.location.hash="#";var f="warn";if(g=="reg_success"){f="success"}$UI.showNoteMsg(b[g],f)}c()}return{init:d}})();var $UserReg=(function(){var d=[1,1,1];function b(){$("#user-reg-form input[name=email]").bind("blur",function(){var f=sanitize($(this).val()).trim();f=f.toLowerCase();d[0]=0;$UI.hideFormError(this);try{check(f,"Email地址为空或错误！").len(6,64).isEmail()}catch(g){d[0]=1;$UI.formError(this,g.message);return}});$("#user-reg-form input[name=username]").bind("blur",function(){var g=sanitize($(this).val()).trim();g=g.toLowerCase();d[1]=0;$UI.hideFormError(this);try{check(g,"用户名只能为字母和数字且长度为5~20！").len(5,20).isAlphanumeric()}catch(f){d[1]=1;$UI.formError(this,f.message);return}});$("#user-reg-form input[name=password]").bind("blur",function(){var f=sanitize($(this).val()).trim();d[2]=0;$UI.hideFormError(this);try{check(f,"密码长度必须在8~16之间！").len(8,16)}catch(g){d[2]=1;$UI.formError(this,g.message);return}});$("#user-reg-form button").bind("click",function(){$("#user-reg-form input[name=email]").blur();$("#user-reg-form input[name=username]").blur();$("#user-reg-form input[name=password]").blur();if(d.join("")!="000"){$UI.showNoteMsg("您输入的信息还有错误，请检查后重试！","warn");return}else{a()}})}function a(){var e=sanitize($("#user-reg-form input[name=password]").val()).trim();e=md5(e);$Util.POST("/register",{email:$("#user-reg-form input[name=email]").val(),username:$("#user-reg-form input[name=username]").val(),password:e},function(f){$UI.showNoteMsg(f.msg,"success");window.location.href="/login#msg=reg_success"})}function c(){b()}return{init:c}})();var $Publish=(function(){var d,c;var a={show:function(){$(".btn_loading").show()},hide:function(){$(".btn_loading").hide()}};function e(){$(".publish-form select[name=category]").bind("change",function(){var j=$(this).find("option:selected").attr("data-type");var g=$(".publish-form .lib-show");if(j==0){for(var h=0;h<g.size();h++){g.eq(h).hide()}}else{for(var h=0;h<g.size();h++){g.eq(h).show()}}});$(".publish-form input[name=libname]").bind("blur",function(){var g=sanitize($(this).val()).trim();var h=this;$UI.hideFormError(this);try{check(g,"类库名称为空或长度不在4-32字符之间！").len(4,32)}catch(i){$UI.formError(this,i.message);return}});$(".publish-form input[name=title]").bind("blur",function(){var h=sanitize($(this).val()).trim();$UI.hideFormError(this);try{check(h,"推荐标题为空或长度不在10-64字符之间！").len(10,64)}catch(g){$UI.formError(this,g.message);return}});$(".publish-form .btn-primary").bind("click",function(){$(".publish-form input[name=libname]").blur();$(".publish-form input[name=title]").blur();b()});$("#file_upload").uploadify({"uploader":"/upload","auto":true,"multi":false,"buttonText":"选择文件","file_post_name":"pic","onUploadSuccess":function(i,j,g){var h=JSON.parse(j);if(h.key){$("#file_url").val(h.key)}}})}function b(){var j={id:$(".publish-form input[name=id]").val()||0,category_id:$(".publish-form select[name=category]").val(),category_type:$(".publish-form select[name=category] option:selected").attr("data-type"),top:$(".publish-form input[name=top]:checked").val(),content:$("#wmd-input").val()};var g=$(".publish-form input[type=text]");for(var h=0;h<g.size();h++){j[g.eq(h).attr("name")]=g.eq(h).val()}a.show();$Util.POST("/publish",j,function(i){$UI.showNoteMsg(i.msg,"success");if(i.lib_id){window.location.href="/lib/"+i.lib_id}else{window.location.href="/my_publish#msg=publish_success"}})}function f(){try{d=Markdown.getSanitizingConverter();c=new Markdown.Editor(d);c.run();e()}catch(g){}}return{init:f}})();var $Lib=(function(){function a(){$("#fav_btn").click(function(){$Util.POST("/fav_add",{lib_id:$(this).attr("data-id")},function(c){$("#fav_btn").html("已收藏")})});$("#use_btn").click(function(){$Util.POST("/use_add",{lib_id:$(this).attr("data-id")},function(c){$("#use_btn").html("已使用 +"+c.count)})});$("#audit_btn").click(function(){$Util.POST("/audit_on",{lib_id:$(this).attr("data-id")},function(c){window.location.reload()})});$("#audit_off_btn").click(function(){$Util.POST("/audit_off",{lib_id:$(this).attr("data-id")},function(c){window.location.reload()})});$("#del_btn").click(function(){$Util.POST("/lib_del",{lib_id:$(this).attr("data-id")},function(c){window.location.reload()})})}function b(){a();try{SyntaxHighlighter.config.clipboardSwf="http://cdn.tuijs.com/syntaxhighlighter/Scripts/clipboard.swf";SyntaxHighlighter.config.stripBrs=true;SyntaxHighlighter.all()}catch(c){}}return{init:b}})();var $Favor=(function(){function a(){$("#userfav_del").on("click",".btn-danger",function(){$Util.POST("/userfav_del",{lib_id:$(this).attr("data-id")},function(b){window.location.reload()})})}return{init:a}})();var $AdminLib=(function(){function a(){$("#audit_list").on("click",".btn-success",function(){$Util.POST("/audit_on",{lib_id:$(this).attr("data-id")},function(b){window.location.reload()})});$("#audit_list").on("click",".btn-danger",function(){$Util.POST("/lib_del",{lib_id:$(this).attr("data-id")},function(b){window.location.reload()})})}return{init:a}})();$(function(){$.ajaxSetup({data:{_token:$Util.getToken()}});$UI.initToTop();$UI.initPage();$UI.initRight();if($PATH){if($PATH=="/register"){$UserReg.init()}else{if($PATH=="/login"){$UserLogin.init()}else{if($PATH=="/column"){$Column.init()}else{if($PATH=="/admin_user"){$UserAdmin.init()}else{if($PATH=="/publish"){$Publish.init()}else{if($PATH=="/lib/:id"){$Lib.init()}else{if($PATH=="/favor"){$Favor.init()}else{if($PATH=="/admin_lib"){$AdminLib.init()}}}}}}}}}});